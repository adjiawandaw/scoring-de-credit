import streamlit as st
import requests
import pandas as pd
import json
from streamlit_lottie import st_lottie
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import seaborn as sns

st.set_page_config(page_title="Scoring CrÃ©dit", layout="wide", page_icon="ğŸ“Š")

def load_lottiefile(filepath: str):
    with open(filepath, "r") as f:
        return json.load(f)

# --- En-tÃªte ---
# --- En-tÃªte Ã©lÃ©gant ---
with st.container():
    col_icon, col_title = st.columns([1, 10])
    with col_icon:
        st.image("https://img.icons8.com/ios-filled/100/1e293b/combo-chart--v1.png", width=60)  # IcÃ´ne en noir Ã©lÃ©gant
    with col_title:
        st.markdown("""
            <style>
                .main-title {
                    font-size: 42px;
                    font-weight: 800;
                    color: #1e293b; /* Bleu foncÃ© / noir bleutÃ© */
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin-bottom: 5px;
                }
                .subtitle {
                    font-size: 17px;
                    color: #4b5563; /* Gris foncÃ© */
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin-top: 0;
                }
            </style>
            <div>
                <div class="main-title">Tableau de bord â€“ Scoring de CrÃ©dit</div>
                <div class="subtitle">Ã‰valuez une demande ou explorez les donnÃ©es clients.</div>
            </div>
        """, unsafe_allow_html=True)


@st.cache_data
def load_data():
    try:
        return pd.read_csv("data/train.csv")
    except:
        return pd.DataFrame()

df = load_data()


# Tabs
tab1, tab2 = st.tabs(["ğŸ“ˆ PrÃ©diction", "ğŸ” Infos Client"])

with tab1:
    with st.form("formulaire_credit"):
        st.subheader("ğŸ“ Informations du Demandeur")
        col1, col2 = st.columns(2)
        with col1:
            gender = st.selectbox("Genre", [0, 1], format_func=lambda x: "Femme" if x == 0 else "Homme")
            married = st.selectbox("Ã‰tat civil", [0, 1], format_func=lambda x: "Non MariÃ©(e)" if x == 0 else "MariÃ©(e)")
            dependents = st.number_input("Personnes Ã  charge", min_value=0, step=1)
            education = st.selectbox("Ã‰ducation", [0, 1], format_func=lambda x: "SupÃ©rieur" if x == 0 else "Non SupÃ©rieur")
            self_employed = st.selectbox("IndÃ©pendant", [0, 1], format_func=lambda x: "Non" if x == 0 else "Oui")
        with col2:
            applicant_income = st.number_input("Revenu Demandeur", min_value=0)
            coapplicant_income = st.number_input("Revenu Co-demandeur", min_value=0)
            loan_amount = st.number_input("Montant du prÃªt (en milliers)", min_value=0)
            loan_term = st.number_input("DurÃ©e du prÃªt (mois)", min_value=1)
            credit_history = st.selectbox("Historique de crÃ©dit", [0.0, 1.0], format_func=lambda x: "Mauvais" if x == 0.0 else "Bon")
            property_area = st.selectbox("Zone", [0, 1, 2], format_func=lambda x: ["Rurale", "Urbaine", "Semi-urbaine"][x])

        submitted = st.form_submit_button("Ã‰valuer ")

    if submitted:
        with st.spinner("Analyse en cours..."):
            data = {
                "Gender": gender,
                "Married": married,
                "Dependents": dependents,
                "Education": education,
                "Self_Employed": self_employed,
                "ApplicantIncome": applicant_income,
                "CoapplicantIncome": coapplicant_income,
                "LoanAmount": loan_amount,
                "Loan_Amount_Term": loan_term,
                "Credit_History": credit_history,
                "Property_Area": property_area
            }

            try:
                response = requests.post("https://api-scoring-c8xa.onrender.com/predict", json=data)
                if response.status_code == 200:
                    result = response.json()
                    statut = result['Statut CrÃ©dit']
                    proba = float(result['ProbabilitÃ© de dÃ©faut']) * 100

                    if statut in ["ApprouvÃ©", "AcceptÃ©"]:
                        statut_affiche = "ApprouvÃ©"
                        st.success(f"âœ… CrÃ©dit ApprouvÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")
                    else:
                        statut_affiche = "RefusÃ©"
                        st.error(f"âŒ CrÃ©dit RefusÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")

                    # Jauge Plotly
                    fig = go.Figure(go.Indicator(
                        mode="gauge+number",
                        value=proba,
                        gauge={
                            'axis': {'range': [0, 100]},
                            'bar': {'color': "red" if statut_affiche == "RefusÃ©" else "green"},
                            'steps': [
                                {'range': [0, 50], 'color': "lightgreen"},
                                {'range': [50, 100], 'color': "salmon"}
                            ]
                        },
                        title={'text': "ProbabilitÃ© de DÃ©faut (%)"}
                    ))
                    fig.update_layout(height=300)
                    st.plotly_chart(fig, use_container_width=True)

                    # Camembert
                    st.markdown("#### ğŸ” RÃ©partition de la dÃ©cision")
                    labels = ['ApprouvÃ©', 'RefusÃ©']
                    values = [100 - proba, proba]
                    colors = ['#27ae60', '#e74c3c']
                    fig1, ax1 = plt.subplots(figsize=(4, 4))
                    ax1.pie(values, labels=labels, autopct='%1.1f%%', startangle=90, colors=colors)
                    ax1.axis('equal')
                    st.pyplot(fig1)
                    plt.close(fig1)

                    # Histogramme revenus
                    if not df.empty:
                        st.markdown("#### ğŸ“Š Comparaison du revenu avec les autres clients")
                        plt.figure(figsize=(8, 3))
                        sns.histplot(df["ApplicantIncome"], color="lightblue", label="Population")
                        plt.axvline(applicant_income, color="red", linestyle="--", label="Client actuel")
                        plt.legend()
                        st.pyplot(plt.gcf())
                        plt.clf()
                else:
                    st.error("âŒ Erreur lors de la prÃ©diction.")
            except Exception as e:
                st.error(f"ğŸš¨ Erreur de connexion Ã  l'API : {e}")


# --- Onglet 2 ---
with tab2:
    st.subheader("ğŸ“‡ SÃ©lectionner un client pour afficher ses informations")

    try:
        df_test = pd.read_csv("data/test.csv")
        id_col = [col for col in df_test.columns if "id" in col.lower()]
        if id_col:
            id_col = id_col[0]
            id_list = df_test[id_col].dropna().unique().tolist()
            selected_id = st.selectbox("ğŸ” SÃ©lectionnez un ID Client", id_list)

            client_data = df_test[df_test[id_col] == selected_id]
            if not client_data.empty:
                st.success(f"âœ… DonnÃ©es du client {selected_id}")

                infos = client_data.iloc[0].to_dict()

                # Style CSS moderne sans carte
                st.markdown("""
                <style>
                    .client-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                        gap: 18px 32px;
                        padding: 20px 10px;
                        font-family: 'Segoe UI', sans-serif;
                        font-size: 16px;
                        color: #333;
                        margin-top: 10px;
                    }
                    .field {
                        font-weight: 600;
                        color: #2c3e50;
                    }
                    .value {
                        font-weight: 500;
                        color: #1a73e8;
                        margin-left: 8px;
                    }
                </style>
                """, unsafe_allow_html=True)

                # DÃ©marrage de la grille
                st.markdown('<div class="client-grid">', unsafe_allow_html=True)

                for key, value in infos.items():
                    # Mapping de valeur binaire
                    if isinstance(value, (int, float)) and value in [0, 1]:
                        mapping = {
                            "gender": {0: "Femme", 1: "Homme"},
                            "married": {0: "Non MariÃ©(e)", 1: "MariÃ©(e)"},
                            "education": {0: "SupÃ©rieur", 1: "Non SupÃ©rieur"},
                            "self_employed": {0: "Non", 1: "Oui"},
                            "credit_history": {0: "Mauvais", 1: "Bon"},
                        }
                        key_lower = key.lower()
                        value = mapping.get(key_lower, {}).get(value, value)

                    # Affichage alignÃ© en ligne "Nom: Valeur"
                    st.markdown(f"<div><span class='field'>{key.replace('_', ' ')} :</span><span class='value'>{value}</span></div>", unsafe_allow_html=True)

                st.markdown('</div>', unsafe_allow_html=True)

                # Graphique optionnel
                with st.expander("ğŸ“Š Variables numÃ©riques"):
                    st.bar_chart(client_data.select_dtypes(include='number').T)

            else:
                st.warning("âš ï¸ Client introuvable.")
        else:
            st.error("âŒ Colonne ID non trouvÃ©e.")
    except FileNotFoundError:
        st.error("âŒ Fichier test.csv introuvable.")
    except Exception as e:
        st.error(f"ğŸš¨ Erreur : {e}")



# --- Animation ---
try:
    animation = load_lottiefile("credit.json")
    st_lottie(animation, speed=1, height=200)
except FileNotFoundError:
    st.warning("âš ï¸ Fichier credit.json introuvable.")
except Exception as e:
    st.warning(f"âš ï¸ Erreur lors du chargement de l'animation : {e}")

















ÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµÂµ
import streamlit as st
import requests
import pandas as pd
import json
from streamlit_lottie import st_lottie
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import seaborn as sns

st.set_page_config(page_title="Scoring CrÃ©dit", layout="wide", page_icon="ğŸ“Š")

def load_lottiefile(filepath: str):
    with open(filepath, "r") as f:
        return json.load(f)

# --- En-tÃªte ---
# --- En-tÃªte Ã©lÃ©gant ---
with st.container():
    col_icon, col_title = st.columns([1, 10])
    with col_icon:
        st.image("https://img.icons8.com/ios-filled/100/1e293b/combo-chart--v1.png", width=60)  # IcÃ´ne en noir Ã©lÃ©gant
    with col_title:
        st.markdown("""
            <style>
                .main-title {
                    font-size: 42px;
                    font-weight: 800;
                    color: #1e293b; /* Bleu foncÃ© / noir bleutÃ© */
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin-bottom: 5px;
                }
                .subtitle {
                    font-size: 17px;
                    color: #4b5563; /* Gris foncÃ© */
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin-top: 0;
                }
            </style>
            <div>
                <div class="main-title">Tableau de bord â€“ Scoring de CrÃ©dit</div>
                <div class="subtitle">Ã‰valuez une demande ou explorez les donnÃ©es clients.</div>
            </div>
        """, unsafe_allow_html=True)


@st.cache_data
def load_data():
    try:
        return pd.read_csv("../data/train.csv")
    except:
        return pd.DataFrame()

df = load_data()


# Tabs
tab1, tab2 = st.tabs(["ğŸ“ˆ PrÃ©diction", "ğŸ” Infos Client"])

with tab1:
    with st.form("formulaire_credit"):
        st.subheader("ğŸ“ Informations du Demandeur")
        col1, col2 = st.columns(2)
        with col1:
            gender = st.selectbox("Genre", [0, 1], format_func=lambda x: "Femme" if x == 0 else "Homme")
            married = st.selectbox("Ã‰tat civil", [0, 1], format_func=lambda x: "Non MariÃ©(e)" if x == 0 else "MariÃ©(e)")
            dependents = st.number_input("Personnes Ã  charge", min_value=0, step=1)
            education = st.selectbox("Ã‰ducation", [0, 1], format_func=lambda x: "SupÃ©rieur" if x == 0 else "Non SupÃ©rieur")
            self_employed = st.selectbox("IndÃ©pendant", [0, 1], format_func=lambda x: "Non" if x == 0 else "Oui")
        with col2:
            applicant_income = st.number_input("Revenu Demandeur", min_value=0)
            coapplicant_income = st.number_input("Revenu Co-demandeur", min_value=0)
            loan_amount = st.number_input("Montant du prÃªt (en milliers)", min_value=0)
            loan_term = st.number_input("DurÃ©e du prÃªt (mois)", min_value=1)
            credit_history = st.selectbox("Historique de crÃ©dit", [0.0, 1.0], format_func=lambda x: "Mauvais" if x == 0.0 else "Bon")
            property_area = st.selectbox("Zone", [0, 1, 2], format_func=lambda x: ["Rurale", "Urbaine", "Semi-urbaine"][x])

        submitted = st.form_submit_button("Ã‰valuer ")

    if submitted:
        with st.spinner("Analyse en cours..."):
            data = {
                "Gender": gender,
                "Married": married,
                "Dependents": dependents,
                "Education": education,
                "Self_Employed": self_employed,
                "ApplicantIncome": applicant_income,
                "CoapplicantIncome": coapplicant_income,
                "LoanAmount": loan_amount,
                "Loan_Amount_Term": loan_term,
                "Credit_History": credit_history,
                "Property_Area": property_area
            }

            try:
                response = requests.post("https://api-scoring-c8xa.onrender.com/predict", json=data)
                if response.status_code == 200:
                    result = response.json()
                    statut = result['Statut CrÃ©dit']
                    proba = float(result['ProbabilitÃ© de dÃ©faut']) * 100

                    if statut in ["ApprouvÃ©", "AcceptÃ©"]:
                        statut_affiche = "ApprouvÃ©"
                        st.success(f"âœ… CrÃ©dit ApprouvÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")
                    else:
                        statut_affiche = "RefusÃ©"
                        st.error(f"âŒ CrÃ©dit RefusÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")

                    # Jauge Plotly
                    fig = go.Figure(go.Indicator(
                        mode="gauge+number",
                        value=proba,
                        gauge={
                            'axis': {'range': [0, 100]},
                            'bar': {'color': "red" if statut_affiche == "RefusÃ©" else "green"},
                            'steps': [
                                {'range': [0, 50], 'color': "lightgreen"},
                                {'range': [50, 100], 'color': "salmon"}
                            ]
                        },
                        title={'text': "ProbabilitÃ© de DÃ©faut (%)"}
                    ))
                    fig.update_layout(height=300)
                    st.plotly_chart(fig, use_container_width=True)

                    # Camembert
                    st.markdown("#### ğŸ” RÃ©partition de la dÃ©cision")
                    labels = ['ApprouvÃ©', 'RefusÃ©']
                    values = [100 - proba, proba]
                    colors = ['#27ae60', '#e74c3c']
                    fig1, ax1 = plt.subplots(figsize=(4, 4))
                    ax1.pie(values, labels=labels, autopct='%1.1f%%', startangle=90, colors=colors)
                    ax1.axis('equal')
                    st.pyplot(fig1)
                    plt.close(fig1)

                    # Histogramme revenus
                    if not df.empty:
                        st.markdown("#### ğŸ“Š Comparaison du revenu avec les autres clients")
                        plt.figure(figsize=(8, 3))
                        sns.histplot(df["ApplicantIncome"], color="lightblue", label="Population")
                        plt.axvline(applicant_income, color="red", linestyle="--", label="Client actuel")
                        plt.legend()
                        st.pyplot(plt.gcf())
                        plt.clf()
                else:
                    st.error("âŒ Erreur lors de la prÃ©diction.")
            except Exception as e:
                st.error(f"ğŸš¨ Erreur de connexion Ã  l'API : {e}")


# --- Onglet 2 ---
with tab2:
    st.subheader("ğŸ“‡ SÃ©lectionner un client pour afficher ses informations")

    try:
        df_test = pd.read_csv("../data/test.csv")
        id_col = [col for col in df_test.columns if "id" in col.lower()]
        if id_col:
            id_col = id_col[0]
            id_list = df_test[id_col].dropna().unique().tolist()
            selected_id = st.selectbox("ğŸ” SÃ©lectionnez un ID Client", id_list)

            client_data = df_test[df_test[id_col] == selected_id]
            if not client_data.empty:
                st.success(f"âœ… DonnÃ©es du client {selected_id}")

                infos = client_data.iloc[0].to_dict()

                # CSS pour mise en forme propre
                st.markdown("""
                <style>
                    .client-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                        gap: 12px 30px;
                        padding: 10px;
                        font-family: 'Segoe UI', sans-serif;
                        font-size: 16px;
                        color: #1e293b;
                        margin-top: 10px;
                    }
                    .field {
                        font-weight: 600;
                        color: #1e293b;
                    }
                    .value {
                        font-weight: 500;
                        color: #2563eb;
                        margin-left: 6px;
                    }
                </style>
                """, unsafe_allow_html=True)

                st.markdown('<div class="client-grid">', unsafe_allow_html=True)

                # Affichage infos client
                for key, value in infos.items():
                    if isinstance(value, (int, float)) and value in [0, 1]:
                        mapping = {
                            "gender": {0: "Femme", 1: "Homme"},
                            "married": {0: "Non MariÃ©(e)", 1: "MariÃ©(e)"},
                            "education": {0: "SupÃ©rieur", 1: "Non SupÃ©rieur"},
                            "self_employed": {0: "Non", 1: "Oui"},
                            "credit_history": {0: "Mauvais", 1: "Bon"},
                        }
                        key_lower = key.lower()
                        value = mapping.get(key_lower, {}).get(value, value)

                    st.markdown(
                        f"<div><span class='field'>{key.replace('_', ' ')} :</span><span class='value'>{value}</span></div>",
                        unsafe_allow_html=True
                    )

                st.markdown('</div>', unsafe_allow_html=True)

                # --- ğŸ”˜ Bouton PrÃ©dire ---
                if st.button("ğŸ” PrÃ©dire Ã  partir de cet ID client"):
                    with st.spinner("Analyse en cours..."):

                        # PrÃ©parer les donnÃ©es pour l'API
                        prediction_data = {
                            "Gender": infos.get("Gender"),
                            "Married": infos.get("Married"),
                            "Dependents": infos.get("Dependents"),
                            "Education": infos.get("Education"),
                            "Self_Employed": infos.get("Self_Employed"),
                            "ApplicantIncome": infos.get("ApplicantIncome"),
                            "CoapplicantIncome": infos.get("CoapplicantIncome"),
                            "LoanAmount": infos.get("LoanAmount"),
                            "Loan_Amount_Term": infos.get("Loan_Amount_Term"),
                            "Credit_History": infos.get("Credit_History"),
                            "Property_Area": infos.get("Property_Area")
                        }

                        try:
                            response = requests.post("https://api-scoring-c8xa.onrender.com/predict", json=prediction_data)
                            if response.status_code == 200:
                                result = response.json()
                                statut = result['Statut CrÃ©dit']
                                proba = float(result['ProbabilitÃ© de dÃ©faut']) * 100

                                if statut in ["ApprouvÃ©", "AcceptÃ©"]:
                                    st.success(f"âœ… CrÃ©dit ApprouvÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")
                                else:
                                    st.error(f"âŒ CrÃ©dit RefusÃ© avec une probabilitÃ© de dÃ©faut de {proba:.2f}%")

                                # Jauge Plotly
                                fig = go.Figure(go.Indicator(
                                    mode="gauge+number",
                                    value=proba,
                                    gauge={
                                        'axis': {'range': [0, 100]},
                                        'bar': {'color': "red" if statut != "ApprouvÃ©" else "green"},
                                        'steps': [
                                            {'range': [0, 50], 'color': "lightgreen"},
                                            {'range': [50, 100], 'color': "salmon"}
                                        ]
                                    },
                                    title={'text': "ProbabilitÃ© de DÃ©faut (%)"}
                                ))
                                fig.update_layout(height=300)
                                st.plotly_chart(fig, use_container_width=True)

                            else:
                                st.error("âŒ Erreur lors de la prÃ©diction.")
                        except Exception as e:
                            st.error(f"ğŸš¨ Erreur de connexion Ã  l'API : {e}")

            else:
                st.warning("âš ï¸ Client introuvable.")
        else:
            st.error("âŒ Colonne ID non trouvÃ©e.")
    except FileNotFoundError:
        st.error("âŒ Fichier test.csv introuvable.")
    except Exception as e:
        st.error(f"ğŸš¨ Erreur : {e}")

